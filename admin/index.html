<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Content Manager</title>
    <!-- Ensure manual init BEFORE loading Decap CMS -->
    <script>window.CMS_MANUAL_INIT = true;</script>
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <style>
      /* 로딩 중 표시 */
      body { font-family: Arial, sans-serif; }
      #loading { text-align: center; padding: 50px; }
      #error { color: red; text-align: center; padding: 20px; display: none; }
    </style>
  </head>
  <body>
    <div id="loading">Decap CMS 로딩 중...</div>
    <div id="error"></div>
    <!-- The CMS mounts here -->

    <script>
      // 디버깅용 로그
      console.log('Admin page loaded');

      // 에러 처리
      window.addEventListener('error', function(e) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').textContent = '오류 발생: ' + e.message;
        document.getElementById('error').style.display = 'block';
        console.error('Error:', e);
      });

      // 수동 초기화로 config.yml 의존 제거 + CMS 로드 대기
      document.addEventListener('DOMContentLoaded', function() {
        function initCMS() {
          window.CMS.init({
            config: {
              backend: {
                name: 'github',
                repo: 'leesg0107/leesg0107.github.io',
                branch: 'master',
                base_url: 'https://decap-cms-oauth-hwu4z1au9-leesg0107s-projects.vercel.app',
                auth_endpoint: '/api/auth/github'
              },
              site_url: 'https://leesg0107.github.io',
              display_url: 'https://leesg0107.github.io',
              media_folder: 'assets/img/uploads',
              public_folder: '/assets/img/uploads',
              publish_mode: 'editorial_workflow',
              collections: [
                {
                  name: 'project',
                  label: 'Project Posts',
                  label_singular: 'Project Post',
                  folder: '_posts/project',
                  create: true,
                  slug: '{{year}}-{{month}}-{{day}}-{{slug}}',
                  extension: 'md',
                  fields: [
                    { label: 'Layout', name: 'layout', widget: 'hidden', default: 'post' },
                    { label: 'Title', name: 'title', widget: 'string' },
                    { label: 'Subtitle', name: 'subtitle', widget: 'string', required: false },
                    { label: 'Author', name: 'author', widget: 'string', default: 'solgyu' },
                    { label: 'Category', name: 'category', widget: 'hidden', default: 'project' },
                    { label: 'Tags', name: 'tags', widget: 'list', required: false },
                    { label: 'MathJax', name: 'mathjax', widget: 'boolean', default: false, required: false },
                    { label: 'Thumbnail', name: 'thumbnail-img', widget: 'image', required: false },
                    { label: 'Body', name: 'body', widget: 'markdown' }
                  ]
                },
                {
                  name: 'study',
                  label: 'Study Posts',
                  folder: '_posts/study',
                  create: true,
                  slug: '{{year}}-{{month}}-{{day}}-{{slug}}',
                  extension: 'md',
                  fields: [
                    { label: 'Layout', name: 'layout', widget: 'hidden', default: 'post' },
                    { label: 'Title', name: 'title', widget: 'string' },
                    { label: 'Subtitle', name: 'subtitle', widget: 'string', required: false },
                    { label: 'Author', name: 'author', widget: 'string', default: 'solgyu' },
                    { label: 'Category', name: 'category', widget: 'hidden', default: 'study' },
                    { label: 'Tags', name: 'tags', widget: 'list', required: false },
                    { label: 'MathJax', name: 'mathjax', widget: 'boolean', default: true, required: false },
                    { label: 'Body', name: 'body', widget: 'markdown' }
                  ]
                },
                {
                  name: 'journey',
                  label: 'Journey Posts',
                  folder: '_posts/journey',
                  create: true,
                  slug: '{{year}}-{{month}}-{{day}}-{{slug}}',
                  extension: 'md',
                  fields: [
                    { label: 'Layout', name: 'layout', widget: 'hidden', default: 'post' },
                    { label: 'Title', name: 'title', widget: 'string' },
                    { label: 'Subtitle', name: 'subtitle', widget: 'string', required: false },
                    { label: 'Author', name: 'author', widget: 'string', default: 'solgyu' },
                    { label: 'Category', name: 'category', widget: 'hidden', default: 'journey' },
                    { label: 'Subcategory', name: 'subcategory', widget: 'select', options: ['dev', 'challenges', 'reflections'], required: false },
                    { label: 'Tags', name: 'tags', widget: 'list', required: false },
                    { label: 'Body', name: 'body', widget: 'markdown' }
                  ]
                }
              ]
            }
          });
        }

        // Wait for Decap CMS global to exist then init
        var attempts = 0;
        (function waitForCMS(){
          if (window.CMS && typeof window.CMS.init === 'function') {
            try { initCMS(); } catch (e) {
              document.getElementById('loading').style.display = 'none';
              document.getElementById('error').textContent = '초기화 오류: ' + (e && e.message ? e.message : e);
              document.getElementById('error').style.display = 'block';
              console.error('CMS init error', e);
            }
            return;
          }
          if (attempts++ < 50) { return setTimeout(waitForCMS, 100); }
          document.getElementById('loading').style.display = 'none';
          document.getElementById('error').textContent = 'Decap CMS 스크립트를 불러오지 못했습니다.';
          document.getElementById('error').style.display = 'block';
          console.error('CMS global not available after waiting');
        })();
      });
    </script>
  </body>
</html>


